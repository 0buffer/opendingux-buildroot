#!/bin/sh

HELP_MENU='To activate or disactivate the TV-out mode without using this menu, you can use the shortcut POWER+Y.'
HELP_MODE='Choose the signal type that your television accepts:\n
\n
- NTSC is used in the Philippines, Japan, and all American countries, except in Brazil, Argentina, Paraguay and Uruguay.\n
\n
- PAL-M is used only in Brazil.\n
\n
- PAL-60 is used on all other countries.\n
\n
- PAL (50Hz) is for legacy TVs only.'

SYSTEM_CONF_FILE="/etc/tvout.conf"
. $SYSTEM_CONF_FILE

CONF_FILE="/etc/local/tvout.conf"
if [ -f "$CONF_FILE" ]; then
	. $CONF_FILE
else
	( echo "# TV-out configuration file." ;
	echo "# Generated by tvout_config" ) > $CONF_FILE
fi

while /bin/true; do
	MODE=`dialog --stdout --help-button --menu 'Choose an action.' 10 50 4 \
		'mode' 'Switch PAL/NTSC' \
		'on' 'Enable TV-out' \
		'off' 'Disable TV-out'`

	case $MODE in
		"")
			exit 1
			;;

		HELP*)
			dialog --msgbox "$HELP_MENU" 8 50
			;;

		mode)
			while /bin/true; do
				VALUE=`dialog --stdout --help-button --menu \
					"Choose your TV type (current: $TV_NORM)" 11 50 5 \
					'ntsc' 'Your TV is NTSC' \
					'pal-60' 'Your TV is PAL (60Hz)' \
					'pal' 'Your TV is PAL (50Hz)' \
					'pal-m' 'Your TV is PAL-M (Brazil)'`

				case "$VALUE" in
					"")
						break;
						;;

					HELP*)
						dialog --msgbox "$HELP_MODE" 18 50
						;;

					*)
						TV_NORM="$VALUE"
						break;
				esac
			done

			# Update config.
			(cat $CONF_FILE |grep -v "TV_NORM" ; echo -n "TV_NORM=$TV_NORM") > $CONF_FILE
			;;

		on|off)
			/usr/sbin/tvtool --$MODE
			exit 0
			;;

		*)
			exit 1
	esac
done
